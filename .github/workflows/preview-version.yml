name: Preview Version

on:
  pull_request:
    branches: [ "main", "develop" ]
    types: [opened, edited, labeled, unlabeled, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  preview-version:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout cÃ³digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ðŸ“– Extraer metadata del proyecto
        id: project_metadata
        run: |
          # Extraer el artifactId del pom.xml
          ARTIFACT_ID=$(awk -F'[<>]' '/<artifactId>/{print $3; exit}' pom.xml)
          echo "ARTIFACT_ID=$ARTIFACT_ID" >> $GITHUB_ENV
          
          # Extraer versiÃ³n (busca primero <version>, luego <revision>)
          VERSION=$(awk '
            BEGIN {found=0}
            /<version>/ && !found {print $0; found=1; exit}
            END {if (!found) {print "<revision>UNKNOWN</revision>"}}' pom.xml | 
            sed -E 's/.*<(version|revision)>(.*)<\/(version|revision)>.*/\2/')
          
          echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "BASE_REF=${{ github.base_ref }}" >> $GITHUB_ENV
          echo "ðŸ” Artifact ID: $ARTIFACT_ID"
          echo "ðŸ” VersiÃ³n actual: $VERSION"

      - name: ðŸ·ï¸ Obtener etiquetas PR
        id: get_labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABEL=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name' | 
            grep -E 'bugfix|fix|hotfix|feature|release' | head -n 1 || true)
          echo "PR_LABEL=$LABEL" >> $GITHUB_ENV
          echo "ðŸ”– Etiqueta detectada: ${LABEL:-ninguna}"

      - name: ðŸ§® Calcular versiÃ³n
        id: calculate_version
        run: |
          # Limpiar y parsear versiÃ³n actual
          CLEAN_VERSION="${CURRENT_VERSION%-SNAPSHOT}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "${CLEAN_VERSION:-0.0.0}"
          
          # Incrementar segÃºn tipo de cambio
          case "$PR_LABEL" in
            "feature") 
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "bugfix"|"fix"|"hotfix")
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "âš ï¸ No se detectÃ³ etiqueta de versiÃ³n, manteniendo versiÃ³n actual"
              ;;
          esac

          # Determinar versiÃ³n final segÃºn rama destino
          if [[ "$BASE_REF" == "main" ]]; then
            FINAL_VERSION="$MAJOR.$MINOR.$PATCH"
            VERSION_TYPE="RELEASE"
          else
            FINAL_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
            VERSION_TYPE="SNAPSHOT"
          fi

          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_ENV
          echo "VERSION_TYPE=$VERSION_TYPE" >> $GITHUB_ENV
          echo "ðŸŽ¯ VersiÃ³n calculada para $BASE_REF: $FINAL_VERSION ($VERSION_TYPE)"

      - name: ðŸ’¬ Publicar comentario en PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configurar emojis segÃºn tipo de versiÃ³n
          if [[ "$VERSION_TYPE" == "RELEASE" ]]; then
            EMOJI="ðŸš€"
            TITLE="RELEASE"
            NOTE="Esta versiÃ³n se publicarÃ¡ oficialmente"
          else
            EMOJI="ðŸ”§"
            TITLE="SNAPSHOT"
            NOTE="VersiÃ³n para desarrollo continuo"
          fi

          # Crear mensaje con formato Markdown
          MESSAGE="### ðŸ“¦ $ARTIFACT_ID\n\n"
          MESSAGE+="| Campo         | Valor                  |\n"
          MESSAGE+="|---------------|------------------------|\n"
          MESSAGE+="| ðŸ‘¤ Autor      | ${{ github.actor }}     |\n"
          MESSAGE+="| ðŸ“… Fecha      | $(date -u +"%Y/%m/%d %H:%M UTC") |\n"
          MESSAGE+="| $EMOJI VersiÃ³n | **$FINAL_VERSION** ($TITLE) |\n"
          MESSAGE+="| ðŸ“Œ Etiqueta   | ${PR_LABEL:-Ninguna}   |\n\n"
          MESSAGE+="> $NOTE\n\n"
          MESSAGE+="<sub>ðŸ¤– Generado automÃ¡ticamente</sub>"

          gh pr comment ${{ github.event.pull_request.number}} --body "$MESSAGE"
          echo "âœ… Comentario publicado en PR"