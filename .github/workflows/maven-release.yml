name: Release Workflow

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üìñ Extraer metadata del proyecto
        id: metadata
        run: |
          ARTIFACT_ID=$(xmllint --xpath "//*[local-name()='project']/*[local-name()='artifactId']/text()" pom.xml)
          VERSION=$(xmllint --xpath "//*[local-name()='project']/*[local-name()='version']/text()" pom.xml)
          
          echo "ARTIFACT_ID=$ARTIFACT_ID" >> $GITHUB_ENV
          echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_VERSION=${VERSION%-SNAPSHOT}" >> $GITHUB_ENV
          
          echo "üîç Artifact: $ARTIFACT_ID"
          echo "üîç Versi√≥n actual: $VERSION"
          echo "üîñ Versi√≥n release: ${VERSION%-SNAPSHOT}"

      - name: üè∑Ô∏è Calcular pr√≥xima versi√≥n SNAPSHOT
        id: next_version
        run: |
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ env.RELEASE_VERSION }}"
          NEXT_VERSION="$MAJOR.$MINOR.$((PATCH + 1))-SNAPSHOT"
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_ENV
          echo "üîÅ Pr√≥xima versi√≥n: $NEXT_VERSION"

      - name: üìù Actualizar a versi√≥n release
        run: |
          sed -i "s|<version>${{ env.CURRENT_VERSION }}</version>|<version>${{ env.RELEASE_VERSION }}</version>|" pom.xml
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git commit -am "chore: [release] ${{ env.ARTIFACT_ID }} v${{ env.RELEASE_VERSION }} [skip ci]"
          git push origin main

      - name: üöÄ Publicar en GitHub Packages
        run: mvn deploy -DskipTests --settings settings.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Crear tag de release
        run: |
          git tag -a "v${{ env.RELEASE_VERSION }}" -m "Release ${{ env.ARTIFACT_ID }} v${{ env.RELEASE_VERSION }}"
          git push origin "v${{ env.RELEASE_VERSION }}"

      - name: üîÑ Preparar pr√≥xima versi√≥n SNAPSHOT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git checkout -b "release/${{ env.RELEASE_VERSION }}"
          sed -i "s|<version>${{ env.RELEASE_VERSION }}</version>|<version>${{ env.NEXT_VERSION }}</version>|" pom.xml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git commit -am "chore: [snapshot] ${{ env.ARTIFACT_ID }} ${{ env.NEXT_VERSION }} [skip ci]"
          git push origin "release/${{ env.RELEASE_VERSION }}"

          # Formato mejorado para el comentario del PR
          PR_BODY=$(cat <<EOF
          ## üöÄ Actualizaci√≥n Autom√°tica de Versi√≥n

          **Detalles del cambio:**
          - **Artifact:** \`${{ env.ARTIFACT_ID }}\`
          - **Versi√≥n Release:** \`${{ env.RELEASE_VERSION }}\`
          - **Nueva Versi√≥n SNAPSHOT:** \`${{ env.NEXT_VERSION }}\`

          **Acciones realizadas:**
          1. Publicada versi√≥n release en GitHub Packages
          2. Creado tag \`v${{ env.RELEASE_VERSION }}\`
          3. Preparada pr√≥xima versi√≥n de desarrollo

          _Este PR fue generado autom√°ticamente por el workflow de release_
          EOF
          )

          gh pr create \
            --base develop \
            --head "release/${{ env.RELEASE_VERSION }}" \
            --title "chore: Bump ${{ env.ARTIFACT_ID }} to ${{ env.NEXT_VERSION }}" \
            --body "$PR_BODY"